generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("PRISMA_DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

enum UserRole {
  USER              // Regular event-goers
  FOUNDER_CURATOR   // Launch team curators with elevated status
  COMMUNITY_CURATOR // Approved community curators
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
  PENDING_VERIFICATION
}

enum CuratorStatus {
  PENDING
  APPROVED
  SUSPENDED
  REVOKED
}

enum EventStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum EventCategory {
  CONCERT
  THEATER
  MUSICAL
  GALLERY_OPENING
  POETRY_READING
  DANCE
  FILM
  LITERARY
}

// =============================================================================
// AUTH MODELS (NextAuth)
// =============================================================================

model User {
  id                    String             @id @default(cuid())
  email                 String             @unique
  emailVerified         DateTime?
  password              String?
  name                  String?
  image                 String?
  role                  UserRole           @default(USER)
  status                UserStatus         @default(ACTIVE)
  phoneNumber           String?
  phoneVerified         Boolean            @default(false)
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  lastLoginAt           DateTime?

  // Relations
  accounts              Account[]
  sessions              Session[]
  preferences           UserPreferences?
  curatorProfile        CuratorProfile?
  curatedEvents         Event[]            @relation("EventCurator")
  savedEvents           SavedEvent[]
  notifications         Notification[]
  conversations         Conversation[]
  legalAcceptances      LegalAcceptance[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// =============================================================================
// EVENT MODELS
// =============================================================================

model Event {
  id                String          @id @default(cuid())
  title             String
  slug              String          @unique
  description       String          @db.Text
  shortDescription  String?         // For cards/previews (max ~200 chars)
  category          EventCategory
  subcategory       String?         // e.g., "jazz", "classical", "contemporary"

  // Date/Time
  startDate         DateTime
  endDate           DateTime?
  doorTime          DateTime?
  isRecurring       Boolean         @default(false)
  recurrenceRule    String?         // iCal RRULE format for recurring events

  // Location
  venueId           String
  venue             Venue           @relation(fields: [venueId], references: [id])

  // Pricing
  priceMin          Int?            // in cents, null = free
  priceMax          Int?            // in cents, for price ranges
  ticketUrl         String?         // External ticketing link
  isFree            Boolean         @default(false)

  // Media
  imageUrl          String?
  imageAlt          String?
  additionalImages  Json?           // Array of { url, alt } objects

  // Curation
  curatorId         String
  curator           User            @relation("EventCurator", fields: [curatorId], references: [id])
  curatorNotes      String?         @db.Text // Curator's personal take/recommendation
  isCuratedPick     Boolean         @default(false) // Highlighted as curated pick
  featured          Boolean         @default(false)
  featuredOrder     Int?

  // Source tracking (for scraping/submission tracking)
  sourceType        String?         // "manual", "scraped", "venue_submitted"
  sourceUrl         String?

  // Status
  status            EventStatus     @default(DRAFT)
  publishedAt       DateTime?

  // Relations
  artists           EventArtist[]
  tags              EventTag[]
  saves             SavedEvent[]

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([startDate])
  @@index([category])
  @@index([status])
  @@index([venueId])
  @@index([curatorId])
}

model Venue {
  id              String    @id @default(cuid())
  name            String
  slug            String    @unique
  description     String?   @db.Text

  // Address
  address         String
  city            String    // South Bend, Mishawaka, Niles, Buchanan, etc.
  state           String    @default("IN")
  zipCode         String
  latitude        Float?
  longitude       Float?
  region          String?   // "michiana", "chicago", etc. for future expansion

  // Contact
  phone           String?
  email           String?
  website         String?

  // Details
  capacity        Int?
  venueType       String?   // "theater", "gallery", "bar", "outdoor", "church", etc.
  accessibility   Json?     // { wheelchair: true, hearing_loop: false, etc. }
  parking         String?   @db.Text

  // Media
  imageUrl        String?

  // Relations
  events          Event[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([city])
  @@index([region])
}

model Artist {
  id              String        @id @default(cuid())
  name            String
  slug            String        @unique
  bio             String?       @db.Text

  // Categories/genres
  primaryGenre    String?
  genres          String[]
  artForm         String?       // "musician", "actor", "poet", "visual_artist", etc.

  // Links
  website         String?
  instagram       String?
  facebook        String?
  spotify         String?
  bandcamp        String?
  youtube         String?

  // Media
  imageUrl        String?

  // Location (for local artists)
  isLocal         Boolean       @default(false)
  city            String?

  // Relations
  events          EventArtist[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([isLocal])
}

model EventArtist {
  id        String   @id @default(cuid())
  eventId   String
  artistId  String
  role      String?  // "headliner", "opener", "performer", "featured", etc.
  order     Int      @default(0)

  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  artist    Artist   @relation(fields: [artistId], references: [id], onDelete: Cascade)

  @@unique([eventId, artistId])
}

model Tag {
  id        String     @id @default(cuid())
  name      String     @unique
  slug      String     @unique
  category  String?    // "genre", "vibe", "accessibility", "audience", etc.

  events    EventTag[]

  createdAt DateTime   @default(now())
}

model EventTag {
  id       String @id @default(cuid())
  eventId  String
  tagId    String

  event    Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([eventId, tagId])
}

// =============================================================================
// USER FEATURES
// =============================================================================

model UserPreferences {
  id                String   @id @default(cuid())
  userId            String   @unique

  // Category preferences (JSON: { "CONCERT": 5, "THEATER": 3, "POETRY_READING": 4 })
  // Values 1-5 for interest level
  categories        Json     @default("{}")
  genres            String[] // ["jazz", "indie rock", "contemporary dance", "improv comedy"]

  // Discovery settings
  priceMin          Int?     // in cents, null = no minimum
  priceMax          Int?     // in cents, null = no maximum
  includeFreeEvents Boolean  @default(true)
  maxDistance       Int?     // miles from home location
  preferredDays     String[] // ["friday", "saturday", "sunday"]
  preferredTimes    String[] // ["afternoon", "evening", "late_night"]

  // Notification settings
  notifyNewEvents   Boolean  @default(true)  // New events in their categories
  notifyMatches     Boolean  @default(true)  // High-match events
  notifyWeekly      Boolean  @default(true)  // Weekly digest
  emailDigest       String   @default("weekly") // "daily", "weekly", "none"

  // Home location for distance calculations
  homeCity          String?
  homeZip           String?
  homeLatitude      Float?
  homeLongitude     Float?

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model SavedEvent {
  id        String   @id @default(cuid())
  userId    String
  eventId   String

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  savedAt   DateTime @default(now())

  @@unique([userId, eventId])
  @@index([userId])
}

// =============================================================================
// CURATOR SYSTEM
// =============================================================================

model CuratorProfile {
  id                String        @id @default(cuid())
  userId            String        @unique

  // Public profile
  displayName       String
  bio               String?       @db.Text
  expertise         String[]      // ["jazz", "theater", "local bands", "visual art"]

  // Status
  status            CuratorStatus @default(PENDING)
  approvedAt        DateTime?
  approvedBy        String?       // Admin user ID who approved

  // Stats (denormalized for performance)
  eventsSubmitted   Int           @default(0)
  eventsApproved    Int           @default(0)
  curatedPicks      Int           @default(0) // Events marked as curated picks

  // Links
  website           String?
  instagram         String?

  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

// =============================================================================
// AI CONCIERGE
// =============================================================================

model Conversation {
  id              String    @id @default(cuid())
  userId          String
  title           String?   // Auto-generated or user-set title

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages        ConversationMessage[]

  lastMessageAt   DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([lastMessageAt])
}

model ConversationMessage {
  id              String       @id @default(cuid())
  conversationId  String
  role            String       // "user" | "assistant"
  content         String       @db.Text

  // For tracking AI responses and recommendations
  metadata        Json?        // { eventsRecommended: ["id1", "id2"], intent: "discovery" }

  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  createdAt       DateTime     @default(now())

  @@index([conversationId])
}

// =============================================================================
// NOTIFICATIONS
// =============================================================================

model Notification {
  id         String   @id @default(cuid())
  userId     String
  type       String   // "event_match", "new_event", "weekly_digest", "curator_approved", etc.
  title      String
  content    String
  data       Json?    // { eventId: "...", matchScore: 85, etc. }
  read       Boolean  @default(false)
  readAt     DateTime?
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
}

// =============================================================================
// LEGAL & COMPLIANCE
// =============================================================================

model LegalAcceptance {
  id                String   @id @default(cuid())
  userId            String
  version           String   // Version of terms accepted
  termsAccepted     Boolean
  privacyAccepted   Boolean
  ageVerified       Boolean
  ipAddress         String?
  userAgent         String?
  acceptedAt        DateTime @default(now())

  user              User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([acceptedAt])
}
